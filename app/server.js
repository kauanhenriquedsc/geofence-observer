const express = require('express');
const turf = require('@turf/turf');
const cors = require('cors');
const {sendSMS } = require('./sms-service'); 
const app = express();

const ALERT_PHONE = '-'; 

app.use(express.json());
app.use(cors());

const routeCoords = [
    [-46.859283,-23.499716],[-46.859498,-23.499606],[-46.859428,-23.499521],[-46.859307,-23.499425],[-46.858749,-23.499112],[-46.858308,-23.498902],[-46.858232,-23.498853],[-46.857281,-23.498377],[-46.857059,-23.49829],[-46.856872,-23.498234],[-46.856707,-23.498218],[-46.856534,-23.498212],[-46.856386,-23.498217],[-46.8562,-23.498235],[-46.854229,-23.498555],[-46.853032,-23.498727],[-46.852578,-23.498811],[-46.852355,-23.498835],[-46.852159,-23.498873],[-46.851668,-23.498944],[-46.851269,-23.498993],[-46.85103,-23.499001],[-46.850627,-23.498978],[-46.850493,-23.498962],[-46.850419,-23.498928],[-46.85033,-23.498903],[-46.849922,-23.498811],[-46.847446,-23.498505],[-46.847371,-23.498499],[-46.847021,-23.498498],[-46.846892,-23.498531],[-46.846766,-23.498562],[-46.846592,-23.498628],[-46.846299,-23.49878],[-46.84615,-23.498872],[-46.845739,-23.499038],[-46.845643,-23.499081],[-46.845447,-23.499185],[-46.845126,-23.499395],[-46.844839,-23.499608],[-46.844346,-23.499905],[-46.844169,-23.499994],[-46.844011,-23.500062],[-46.843799,-23.50013],[-46.842875,-23.500362],[-46.842042,-23.500557],[-46.841524,-23.500669],[-46.84105,-23.500793],[-46.840089,-23.501012],[-46.838362,-23.501437],[-46.838287,-23.501583],[-46.838314,-23.501644],[-46.838437,-23.50208],[-46.838474,-23.502249],[-46.838604,-23.50348],[-46.838629,-23.503852],[-46.838634,-23.50411],[-46.838721,-23.504797],[-46.838702,-23.504971],[-46.838778,-23.506075],[-46.838762,-23.506213],[-46.838717,-23.506397],[-46.838633,-23.506563],[-46.838517,-23.506724],[-46.838379,-23.506858],[-46.838193,-23.506968],[-46.838052,-23.507016],[-46.837918,-23.507051],[-46.837589,-23.507093],[-46.836051,-23.507231],[-46.834875,-23.50732],[-46.834424,-23.5073],[-46.833169,-23.507455],[-46.831796,-23.507656],[-46.831689,-23.50771],[-46.831497,-23.507752],[-46.830586,-23.507918],[-46.829293,-23.508137],[-46.829171,-23.508162],[-46.829041,-23.508208],[-46.824555,-23.508809],[-46.823274,-23.509003],[-46.822518,-23.509182],[-46.820681,-23.509714],[-46.820152,-23.509839],[-46.819635,-23.509928],[-46.818873,-23.510028],[-46.817174,-23.510209],[-46.815928,-23.510338],[-46.814948,-23.510426],[-46.814117,-23.510481],[-46.812999,-23.510519],[-46.812631,-23.510545],[-46.812169,-23.510589],[-46.810573,-23.510809],[-46.80902,-23.511052],[-46.808385,-23.511138],[-46.807567,-23.511266],[-46.806061,-23.511578],[-46.805032,-23.511827],[-46.803808,-23.512153],[-46.802703,-23.51248],[-46.80073,-23.51311],[-46.798874,-23.513779],[-46.795622,-23.515071],[-46.794346,-23.515569],[-46.790163,-23.517269],[-46.788647,-23.517864],[-46.788125,-23.51806],[-46.78591,-23.51895],[-46.785509,-23.519108],[-46.784203,-23.519573],[-46.783638,-23.519734],[-46.78315,-23.519856],[-46.78241,-23.520009],[-46.781487,-23.520146],[-46.780332,-23.520338],[-46.779286,-23.520541],[-46.778463,-23.520677],[-46.77809,-23.520729],[-46.777647,-23.520757],[-46.776992,-23.520814],[-46.776617,-23.520877],[-46.776266,-23.520968],[-46.776102,-23.521029],[-46.775925,-23.521119],[-46.775724,-23.521244],[-46.775154,-23.521736],[-46.774717,-23.522141],[-46.77452,-23.522291],[-46.774283,-23.522447],[-46.773852,-23.522791],[-46.773737,-23.522924],[-46.773676,-23.523019],[-46.773593,-23.523192],[-46.773554,-23.523319],[-46.773534,-23.523416],[-46.77351,-23.523663],[-46.773568,-23.524375],[-46.773623,-23.524706],[-46.773721,-23.524878],[-46.7739,-23.526024],[-46.774017,-23.526591],[-46.774199,-23.527416],[-46.774208,-23.527525],[-46.774199,-23.527734],[-46.774158,-23.528051],[-46.774125,-23.528234],[-46.773504,-23.531103],[-46.77349,-23.531236],[-46.773371,-23.532009],[-46.773264,-23.53258],[-46.773159,-23.533326],[-46.772842,-23.533258],[-46.772908,-23.532715],[-46.772886,-23.53248],[-46.772895,-23.532264],[-46.772929,-23.53203],[-46.773202,-23.530676],[-46.773304,-23.530062],[-46.773316,-23.529869],[-46.77367,-23.529543],[-46.776186,-23.527734],[-46.776387,-23.527954],[-46.776443,-23.527997],[-46.776486,-23.528009],[-46.777399,-23.528147],[-46.778368,-23.528271],[-46.778252,-23.528326],[-46.778225,-23.528468],[-46.778123,-23.52854],[-46.777828,-23.528678],[-46.777159,-23.528959],[-46.777088,-23.529032],[-46.77712,-23.529136],[-46.777253,-23.529389],[-46.777768,-23.529139]
];
const route = turf.lineString(routeCoords);
const buffer = turf.buffer(route, 20, { units: 'meters' }); 

let lastClientPoint = null;
let clientHistory = [];

app.use(express.static('public'));

app.get('/geofence', (req, res) => {
    res.json({ route: route, buffer: buffer });
});

app.post('/check-geofence', async (req, res) => {
    const { lat, lng } = req.body;
    if (typeof lat !== 'number' || typeof lng !== 'number') {
        return res.status(400).json({ error: "lat/lng inválidos" });
    }
    const pt = turf.point([lng, lat]);
    // point in polygon - search if Point (Geometry object) [lat, lng] is inside of Geofence
    const inside = turf.booleanPointInPolygon(pt, buffer);
    res.json({ inside });
});

app.post('/client-point', (req, res) => {
    const { lat, lng } = req.body;
    if (typeof lat !== 'number' || typeof lng !== 'number') {
        return res.status(400).json({ error: "lat/lng inválidos" });
    }
    lastClientPoint = { lat, lng };
    clientHistory.push({ lat, lng });
    if (clientHistory.length > 500) clientHistory.shift();
    res.json({ ok: true });
});

app.get('/client-last-point', (req, res) => {
    res.json(lastClientPoint || {});
});

app.get('/client-history', (req, res) => {
    res.json(clientHistory);
});

const PORT = 3001;
app.listen(PORT, () => {
    console.log('API rodando em http://localhost:' + PORT);
});
